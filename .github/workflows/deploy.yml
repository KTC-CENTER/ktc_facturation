name: Deploy KTC-Invoice to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOMAIN: facturation.kamer-center.net
  VPS_IP: 81.169.177.240
  APP_DIR: /opt/apps/ktc-invoice
  CONTAINER_NAME: ktc-invoice-app

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_mysql, mbstring, gd, zip, intl, opcache
          coverage: none
      
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-scripts
      
      - name: Check Symfony requirements
        run: php bin/console about || true

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.VPS_IP }} >> ~/.ssh/known_hosts
      
      - name: Create deployment directories
        run: |
          ssh root@${{ env.VPS_IP }} << 'ENDSSH'
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p /etc/letsencrypt
            mkdir -p ${{ env.APP_DIR }}/certbot/www
          ENDSSH
      
      - name: Sync application files
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'var/cache/*' \
            --exclude 'var/log/*' \
            --exclude '.env.local' \
            --exclude 'public/uploads/*' \
            ./ root@${{ env.VPS_IP }}:${{ env.APP_DIR }}/
      
      - name: Create production .env file
        run: |
          ssh root@${{ env.VPS_IP }} << 'ENDSSH'
            cat > ${{ env.APP_DIR }}/.env.local << 'ENVFILE'
          APP_ENV=prod
          APP_DEBUG=0
          APP_SECRET=${{ secrets.APP_SECRET }}
          DATABASE_URL=mysql://admin:${{ secrets.DB_PASSWORD }}@ktc-invoice-db:3306/ktc_invoice?serverVersion=8.0
          MAILER_DSN=${{ secrets.MAILER_DSN }}
          BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
          BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}
          ENVFILE
          ENDSSH
      
      - name: Create Docker environment file
        run: |
          ssh root@${{ env.VPS_IP }} << 'ENDSSH'
            cat > ${{ env.APP_DIR }}/.env << 'ENVFILE'
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
          ENVFILE
          ENDSSH
      
      - name: Install SSL Certificate (first time only)
        run: |
          ssh root@${{ env.VPS_IP }} << 'ENDSSH'
            cd ${{ env.APP_DIR }}
            
            # Check if certificate exists
            if [ ! -f "/etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem" ]; then
              echo "Installing SSL certificate for ${{ env.DOMAIN }}..."
              
              # Install certbot if not present
              apt-get update && apt-get install -y certbot
              
              # Stop any service using port 80
              docker stop ktc-invoice-nginx 2>/dev/null || true
              
              # Get certificate
              certbot certonly --standalone \
                -d ${{ env.DOMAIN }} \
                --email admin@kamer-center.net \
                --agree-tos \
                --non-interactive
              
              echo "SSL certificate installed successfully!"
            else
              echo "SSL certificate already exists, skipping..."
            fi
          ENDSSH
      
      - name: Build and Deploy with Docker
        run: |
          ssh root@${{ env.VPS_IP }} << 'ENDSSH'
            cd ${{ env.APP_DIR }}
            
            # Stop existing containers
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            
            # Build and start containers
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d
            
            # Wait for app container to be ready
            echo "Waiting for containers to start..."
            sleep 10
            
            # Run database migrations
            docker exec ${{ env.CONTAINER_NAME }} php bin/console doctrine:migrations:migrate --no-interaction || true
            docker exec ${{ env.CONTAINER_NAME }} php bin/console doctrine:schema:update --force || true
            
            # Clear and warm cache
            docker exec ${{ env.CONTAINER_NAME }} php bin/console cache:clear --env=prod
            docker exec ${{ env.CONTAINER_NAME }} php bin/console cache:warmup --env=prod
            
            # Set permissions
            docker exec ${{ env.CONTAINER_NAME }} chown -R www-data:www-data var public/uploads
            docker exec ${{ env.CONTAINER_NAME }} chmod -R 775 var public/uploads
            
            echo "Deployment completed successfully!"
          ENDSSH
      
      - name: Health Check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.DOMAIN }} --insecure || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "302" ]; then
            echo "âœ… Application is responding (HTTP $response)"
          else
            echo "âš ï¸ Application returned HTTP $response"
          fi
      
      - name: Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Application is live at: https://${{ env.DOMAIN }}"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # Here you could add Slack/Discord/Email notification
