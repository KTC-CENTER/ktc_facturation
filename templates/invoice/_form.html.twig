{{ form_start(form, {'attr': {'class': 'space-y-6', 'id': 'document-form'}}) }}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Contenu principal -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Informations générales -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-semibold text-gray-900">Informations générales</h3>
            </div>
            <div class="card-body space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>{{ form_row(form.client) }}</div>
                    <div>{{ form_row(form.object) }}</div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>{{ form_row(form.issueDate) }}</div>
                    <div>{{ form_row(form.dueDate) }}</div>
                    <div>{{ form_row(form.taxRate) }}</div>
                </div>
            </div>
        </div>

        <!-- Lignes du document -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">
                    Lignes du document
                    <span class="text-sm font-normal text-gray-500" id="item-count">(0 lignes)</span>
                </h3>
                <button type="button" class="btn btn-primary btn-sm" onclick="addItem()">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Ajouter une ligne
                </button>
            </div>
            <div class="card-body p-0">
                <div class="overflow-x-auto">
                    <table class="table w-full">
                        <thead>
                            <tr class="bg-gray-50 text-xs uppercase text-gray-500">
                                <th class="w-8 px-2"></th>
                                <th class="px-2 py-3">Produit</th>
                                <th class="px-2 py-3">Désignation</th>
                                <th class="w-24 px-2 py-3">Qté</th>
                                <th class="w-32 px-2 py-3">Prix unit.</th>
                                <th class="w-20 px-2 py-3">Remise %</th>
                                <th class="w-32 px-2 py-3 text-right">Total HT</th>
                                <th class="w-16 px-2 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="items-container">
                            {% for item in form.items %}
                                {{ include('invoice/_item_row.html.twig', {item: item, index: loop.index0}) }}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Template for new items -->
                <template id="item-template">
                    {{ include('invoice/_item_row.html.twig', {item: form.items.vars.prototype, index: '__name__'}) }}
                </template>
            </div>
        </div>

        <!-- Notes et conditions -->
        <div class="card">
            <div class="card-header">
                <h3 class="font-semibold text-gray-900">Notes et conditions</h3>
            </div>
            <div class="card-body space-y-4">
                <div>{{ form_row(form.notes) }}</div>
                <div>{{ form_row(form.conditions) }}</div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Totaux -->
        <div class="card sticky top-4">
            <div class="card-header">
                <h3 class="font-semibold text-gray-900">Récapitulatif</h3>
            </div>
            <div class="card-body space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-500">Total HT</span>
                    <span class="font-medium" id="total-ht">0 {{ default_currency }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">TVA (<span id="tax-rate-display">{{ form.taxRate.vars.value|default(19.25) }}</span>%)</span>
                    <span class="font-medium" id="total-tva">0 {{ default_currency }}</span>
                </div>
                <div class="flex justify-between text-lg border-t pt-3">
                    <span class="font-bold">Total TTC</span>
                    <span class="font-bold text-blue-600" id="total-ttc">0 {{ default_currency }}</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-body space-y-3">
                <button type="submit" class="btn btn-primary w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {{ button_label|default('Enregistrer') }}
                </button>
                <a href="{{ path('app_invoice_index') }}" class="btn btn-secondary w-full">Annuler</a>
            </div>
        </div>
    </div>
</div>

{{ form_end(form) }}

<script>
var itemIndex = document.querySelectorAll('#items-container .document-item').length;
var currency = '{{ default_currency }}';

function fmt(n) { return new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 0}).format(n) + ' ' + currency; }

function getTaxRate() {
    var el = document.querySelector('[name*="taxRate"]');
    return el ? parseFloat(el.value) || 0 : 19.25;
}

function loadProduct(sel) {
    var opt = sel.selectedOptions[0];
    if (!opt || !opt.value) return;
    var row = sel.closest('.document-item');
    if (!row) return;
    var des = row.querySelector('.designation-input');
    var desc = row.querySelector('.description-input');
    var price = row.querySelector('.price-input');
    if (des && opt.dataset.name) des.value = opt.dataset.code + ' - ' + opt.dataset.name;
    if (desc && opt.dataset.description) desc.value = opt.dataset.description;
    if (price && opt.dataset.price) price.value = opt.dataset.price;
    calcLine(sel);
}

function calcLine(el) {
    var row = el.closest('.document-item');
    if (!row) return;
    var qty = parseFloat(row.querySelector('.qty-input')?.value) || 0;
    var price = parseFloat(row.querySelector('.price-input')?.value) || 0;
    var disc = parseFloat(row.querySelector('.discount-input')?.value) || 0;
    var total = qty * price * (1 - disc / 100);
    var span = row.querySelector('.line-total');
    if (span) span.textContent = fmt(total);
    calcTotals();
}

function calcTotals() {
    var totalHT = 0;
    document.querySelectorAll('#items-container .document-item').forEach(function(row) {
        var qty = parseFloat(row.querySelector('.qty-input')?.value) || 0;
        var price = parseFloat(row.querySelector('.price-input')?.value) || 0;
        var disc = parseFloat(row.querySelector('.discount-input')?.value) || 0;
        totalHT += qty * price * (1 - disc / 100);
    });
    var taxRate = getTaxRate();
    var totalTVA = totalHT * taxRate / 100;
    var totalTTC = totalHT + totalTVA;
    document.getElementById('total-ht').textContent = fmt(totalHT);
    document.getElementById('total-tva').textContent = fmt(totalTVA);
    document.getElementById('total-ttc').textContent = fmt(totalTTC);
    var trd = document.getElementById('tax-rate-display');
    if (trd) trd.textContent = taxRate;
    updateItemCount();
}

function addItem() {
    var tpl = document.getElementById('item-template').innerHTML;
    var html = tpl.replace(/__name__/g, itemIndex);
    document.getElementById('items-container').insertAdjacentHTML('beforeend', html);
    itemIndex++;
    updateItemCount();
    // Focus first input
    var rows = document.querySelectorAll('#items-container .document-item');
    var last = rows[rows.length - 1];
    if (last) { var inp = last.querySelector('select, input'); if (inp) inp.focus(); }
}

function removeItem(btn) {
    var row = btn.closest('.document-item');
    var count = document.querySelectorAll('#items-container .document-item').length;
    if (count <= 1) { alert('Vous devez avoir au moins une ligne.'); return; }
    row.style.opacity = '0.3';
    setTimeout(function() { row.remove(); calcTotals(); }, 150);
}

function duplicateItem(btn) {
    var row = btn.closest('.document-item');
    var clone = row.cloneNode(true);
    clone.querySelectorAll('[name]').forEach(function(el) {
        el.name = el.name.replace(/\[\d+\]/, '[' + itemIndex + ']');
        if (el.id) el.id = el.id.replace(/_\d+_/, '_' + itemIndex + '_');
    });
    clone.querySelectorAll('[for]').forEach(function(el) {
        if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/_\d+_/, '_' + itemIndex + '_');
    });
    row.parentNode.insertBefore(clone, row.nextSibling);
    itemIndex++;
    updateItemCount();
    calcTotals();
}

function updateItemCount() {
    var c = document.querySelectorAll('#items-container .document-item').length;
    var el = document.getElementById('item-count');
    if (el) el.textContent = '(' + c + ' ligne' + (c > 1 ? 's' : '') + ')';
}

// Tax rate change listener
document.addEventListener('DOMContentLoaded', function() {
    var taxInput = document.querySelector('[name*="taxRate"]');
    if (taxInput) taxInput.addEventListener('input', calcTotals);
    calcTotals();
    // If no items, add one
    if (document.querySelectorAll('#items-container .document-item').length === 0) addItem();
});
</script>
