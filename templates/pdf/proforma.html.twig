<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Proforma {{ proforma.reference }}</title>
    <style>
        @page { margin: 15mm 15mm 25mm 15mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DejaVu Sans', Arial, sans-serif; font-size: 9.5px; line-height: 1.5; color: #1f2937; }
        .header { display: table; width: 100%; margin-bottom: 15px; }
        .header-left, .header-right { display: table-cell; vertical-align: top; }
        .header-right { text-align: right; width: 45%; }
        .logo-img { max-height: 65px; max-width: 200px; }
        .company-name { font-size: 20px; font-weight: bold; color: #1E3A5F; margin-bottom: 4px; }
        .company-info { font-size: 8.5px; color: #6b7280; line-height: 1.6; }
        .company-legal { font-size: 7.5px; color: #9ca3af; margin-top: 4px; }
        .title-bar { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white; padding: 12px 20px; margin-bottom: 18px; border-radius: 4px; display: table; width: 100%; }
        .title-bar-left, .title-bar-right { display: table-cell; vertical-align: middle; }
        .title-bar-right { text-align: right; }
        .title-bar h1 { font-size: 20px; font-weight: bold; margin: 0; letter-spacing: 2px; }
        .title-bar .ref { font-size: 13px; opacity: 0.9; }
        .accent-bar { height: 3px; background: linear-gradient(90deg, #7c3aed, #a855f7, #e9d5ff); margin-bottom: 15px; border-radius: 2px; }
        .info-section { display: table; width: 100%; margin-bottom: 15px; }
        .info-box { display: table-cell; width: 50%; vertical-align: top; }
        .info-box.right { padding-left: 20px; }
        .info-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: #9ca3af; font-weight: bold; margin-bottom: 4px; }
        .client-name { font-size: 14px; font-weight: bold; color: #7c3aed; }
        .client-info { font-size: 9px; color: #6b7280; margin-top: 3px; line-height: 1.6; }
        .doc-info-grid { background: #f8fafc; padding: 10px 12px; border-radius: 4px; border-left: 3px solid #a855f7; }
        .doc-info-row { display: table; width: 100%; margin-bottom: 2px; }
        .doc-info-label, .doc-info-value { display: table-cell; font-size: 9px; }
        .doc-info-label { color: #6b7280; width: 40%; }
        .doc-info-value { color: #1f2937; font-weight: 500; }
        .validity-notice { padding: 8px 14px; margin-bottom: 15px; font-size: 9.5px; border-radius: 4px; }
        .validity-active { background: #f5f3ff; border: 1px solid #c4b5fd; color: #5b21b6; }
        .validity-expired { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        table.items { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        table.items th { background: #7c3aed; color: white; padding: 8px 10px; text-align: left; font-size: 8.5px; text-transform: uppercase; letter-spacing: 0.5px; }
        table.items th:first-child { border-radius: 4px 0 0 0; }
        table.items th:last-child { border-radius: 0 4px 0 0; }
        table.items td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; font-size: 9.5px; }
        table.items tr:nth-child(even) { background: #faf5ff; }
        table.items .center { text-align: center; }
        table.items .right { text-align: right; }
        .item-name { font-weight: 600; color: #111827; }
        .item-desc { font-size: 8px; color: #6b7280; margin-top: 2px; }
        .totals-section { display: table; width: 100%; margin-bottom: 12px; }
        .notes-box { display: table-cell; width: 55%; vertical-align: top; padding-right: 20px; }
        .totals-box { display: table-cell; width: 45%; vertical-align: top; }
        table.totals { width: 100%; border-collapse: collapse; border-radius: 4px; overflow: hidden; }
        table.totals td { padding: 7px 12px; font-size: 10px; }
        table.totals tr { border-bottom: 1px solid #e5e7eb; }
        table.totals tr.total-row { background: #7c3aed; color: white; }
        table.totals tr.total-row td { font-size: 13px; font-weight: bold; border: none; padding: 10px 12px; }
        .notes h4 { color: #7c3aed; margin-bottom: 4px; font-size: 10px; }
        .notes p { font-size: 8.5px; color: #6b7280; }
        .amount-words { background: #f5f3ff; padding: 8px 12px; margin-bottom: 12px; border-left: 3px solid #a855f7; border-radius: 0 4px 4px 0; font-size: 9.5px; }
        .amount-words strong { color: #7c3aed; }
        .conditions { margin-top: 10px; padding: 8px 12px; background: #f8fafc; border-radius: 4px; font-size: 8px; color: #64748b; }
        .conditions h4 { color: #475569; margin-bottom: 3px; font-size: 9px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; font-size: 7.5px; color: #9ca3af; border-top: 2px solid #7c3aed; padding: 8px 15mm; background: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            {% if logo_base64 %}
            <img src="{{ logo_base64 }}" alt="Logo" class="logo-img" style="margin-bottom:8px;">
            {% endif %}
            <div class="company-name">{{ settings.companyName }}</div>
            <div class="company-info">
                {{ settings.address }}<br>
                {% if settings.postalCode %}BP : {{ settings.postalCode }} {% endif %}{{ settings.city }}, {{ settings.country }}<br>
                Tél : {{ settings.phones }} | Email : {{ settings.email }}
                {% if settings.website %}<br>{{ settings.website }}{% endif %}
            </div>
            <div class="company-legal">
                {% if settings.rccm %}RCCM : {{ settings.rccm }}{% endif %}
                {% if settings.taxId %} | N° Contrib. : {{ settings.taxId }}{% endif %}
            </div>
        </div>
        <div class="header-right">
            <div class="doc-info-grid">
                <div class="doc-info-row"><span class="doc-info-label">Date d'émission</span><span class="doc-info-value">{{ proforma.issueDate|date('d/m/Y') }}</span></div>
                <div class="doc-info-row"><span class="doc-info-label">Valide jusqu'au</span><span class="doc-info-value">{{ proforma.validUntil|date('d/m/Y') }}</span></div>
            </div>
        </div>
    </div>

    <div class="title-bar">
        <div class="title-bar-left"><h1>PROFORMA</h1></div>
        <div class="title-bar-right"><div class="ref">N° {{ proforma.reference }}</div></div>
    </div>

    <div class="info-section">
        <div class="info-box">
            <div class="info-label">Client</div>
            <div class="client-name">{{ proforma.client.name }}</div>
            <div class="client-info">
                {% if proforma.client.address %}{{ proforma.client.address }}<br>{% endif %}
                {% if proforma.client.city %}{{ proforma.client.city }}{% if proforma.client.country %}, {{ proforma.client.country }}{% endif %}<br>{% endif %}
                {% if proforma.client.phone %}Tél : {{ proforma.client.phone }}<br>{% endif %}
                {% if proforma.client.email %}{{ proforma.client.email }}{% endif %}
            </div>
        </div>
        <div class="info-box right">
            {% if proforma.isExpired %}
            <div class="validity-notice validity-expired"><strong>⚠ PROFORMA EXPIRÉE</strong></div>
            {% else %}
            <div class="validity-notice validity-active"><strong>✓ Valide jusqu'au {{ proforma.validUntil|date('d/m/Y') }}</strong></div>
            {% endif %}
            {% if proforma.object %}<div style="font-size:10px;margin-top:5px;"><strong>Objet :</strong> {{ proforma.object }}</div>{% endif %}
        </div>
    </div>

    <div class="accent-bar"></div>

    <table class="items">
        <thead>
            <tr>
                <th style="width:5%">#</th>
                <th style="width:40%">Désignation</th>
                <th style="width:10%" class="center">Qté</th>
                <th style="width:15%" class="right">P.U. ({{ settings.currency }})</th>
                <th style="width:10%" class="center">Remise</th>
                <th style="width:20%" class="right">Total ({{ settings.currency }})</th>
            </tr>
        </thead>
        <tbody>
            {% for item in proforma.items %}
            <tr>
                <td class="center">{{ loop.index }}</td>
                <td>
                    <div class="item-name">{{ item.designation }}</div>
                    {% if item.description %}<div class="item-desc">{{ item.description }}</div>{% endif %}
                </td>
                <td class="center">{{ item.quantityFloat|number_format(2, ',', ' ') }}</td>
                <td class="right">{{ item.unitPriceFloat|number_format(0, ',', ' ') }}</td>
                <td class="center">{{ item.discountFloat > 0 ? item.discountFloat ~ '%' : '-' }}</td>
                <td class="right"><strong>{{ item.totalFloat|number_format(0, ',', ' ') }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals-section">
        <div class="notes-box">
            {% if proforma.notes %}
            <div class="notes"><h4>Notes</h4><p>{{ proforma.notes|nl2br }}</p></div>
            {% endif %}
        </div>
        <div class="totals-box">
            <table class="totals">
                <tr><td>Total HT</td><td class="right">{{ proforma.totalHTFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                {% if proforma.taxRateFloat > 0 %}
                <tr><td>{{ settings.taxLabel|default('TVA') }} ({{ proforma.taxRateFloat }}%)</td><td class="right">{{ proforma.totalTVAFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                {% endif %}
                <tr class="total-row"><td>TOTAL TTC</td><td class="right">{{ proforma.totalTTCFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
            </table>
        </div>
    </div>

    <div class="amount-words">
        <strong>Arrêté la présente proforma à la somme de :</strong>
        {{ proforma.totalTTCFloat|number_format(0, ',', ' ') }} {{ settings.currency }}
    </div>

    {% if proforma.conditions %}
    <div class="conditions"><h4>Conditions</h4><p>{{ proforma.conditions|nl2br }}</p></div>
    {% endif %}

    <div class="footer">
        {{ settings.companyName }} — {{ settings.address }}, {{ settings.city }}
        {% if settings.rccm %} | RCCM : {{ settings.rccm }}{% endif %}
        | Tél : {{ settings.phones }} | {{ settings.email }}
    </div>
</body>
</html>
