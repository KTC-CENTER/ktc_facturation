<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Facture {{ invoice.reference }}</title>
    <style>
        @page { margin: 15mm 15mm 25mm 15mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DejaVu Sans', Arial, sans-serif; font-size: 9.5px; line-height: 1.5; color: #1f2937; }
        
        /* Header */
        .header { display: table; width: 100%; margin-bottom: 15px; }
        .header-left, .header-right { display: table-cell; vertical-align: top; }
        .header-right { text-align: right; width: 45%; }
        .logo-img { max-height: 65px; max-width: 200px; }
        .company-name { font-size: 20px; font-weight: bold; color: #1E3A5F; margin-bottom: 4px; }
        .company-info { font-size: 8.5px; color: #6b7280; line-height: 1.6; }
        .company-legal { font-size: 7.5px; color: #9ca3af; margin-top: 4px; }
        
        /* Title bar */
        .title-bar { background: linear-gradient(135deg, #1E3A5F 0%, #2E86AB 100%); color: white; padding: 12px 20px; margin-bottom: 18px; border-radius: 4px; display: table; width: 100%; }
        .title-bar-left, .title-bar-right { display: table-cell; vertical-align: middle; }
        .title-bar-right { text-align: right; }
        .title-bar h1 { font-size: 20px; font-weight: bold; margin: 0; letter-spacing: 2px; }
        .title-bar .ref { font-size: 13px; opacity: 0.9; }
        .title-bar .date { font-size: 10px; opacity: 0.8; }
        
        /* Divider */
        .accent-bar { height: 3px; background: linear-gradient(90deg, #1E3A5F, #2E86AB, #A3C4DC); margin-bottom: 15px; border-radius: 2px; }
        
        /* Info section */
        .info-section { display: table; width: 100%; margin-bottom: 15px; }
        .info-box { display: table-cell; width: 50%; vertical-align: top; }
        .info-box.right { padding-left: 20px; }
        .info-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1px; color: #9ca3af; font-weight: bold; margin-bottom: 4px; }
        .client-name { font-size: 14px; font-weight: bold; color: #1E3A5F; }
        .client-info { font-size: 9px; color: #6b7280; margin-top: 3px; line-height: 1.6; }
        .doc-info-grid { background: #f8fafc; padding: 10px 12px; border-radius: 4px; border-left: 3px solid #2E86AB; }
        .doc-info-row { display: table; width: 100%; margin-bottom: 2px; }
        .doc-info-label, .doc-info-value { display: table-cell; font-size: 9px; }
        .doc-info-label { color: #6b7280; width: 40%; }
        .doc-info-value { color: #1f2937; font-weight: 500; }
        
        /* Status */
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 9px; font-weight: bold; margin-bottom: 12px; }
        .status-paid { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .status-overdue { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .status-pending { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        
        /* Table */
        table.items { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        table.items thead { }
        table.items th { background: #1E3A5F; color: white; padding: 8px 10px; text-align: left; font-size: 8.5px; text-transform: uppercase; letter-spacing: 0.5px; }
        table.items th:first-child { border-radius: 4px 0 0 0; }
        table.items th:last-child { border-radius: 0 4px 0 0; }
        table.items td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; font-size: 9.5px; }
        table.items tr:nth-child(even) { background: #f9fafb; }
        table.items .center { text-align: center; }
        table.items .right { text-align: right; }
        .item-name { font-weight: 600; color: #111827; }
        .item-desc { font-size: 8px; color: #6b7280; margin-top: 2px; }
        
        /* Totals */
        .totals-section { display: table; width: 100%; margin-bottom: 12px; }
        .notes-box { display: table-cell; width: 55%; vertical-align: top; padding-right: 20px; }
        .totals-box { display: table-cell; width: 45%; vertical-align: top; }
        table.totals { width: 100%; border-collapse: collapse; border-radius: 4px; overflow: hidden; }
        table.totals td { padding: 7px 12px; font-size: 10px; }
        table.totals tr { border-bottom: 1px solid #e5e7eb; }
        table.totals tr.total-row { background: #1E3A5F; color: white; }
        table.totals tr.total-row td { font-size: 13px; font-weight: bold; border: none; padding: 10px 12px; }
        table.totals tr.paid-row { background: #ecfdf5; }
        table.totals tr.due-row { background: #fef2f2; }
        
        /* Misc */
        .notes h4 { color: #1E3A5F; margin-bottom: 4px; font-size: 10px; }
        .notes p { font-size: 8.5px; color: #6b7280; }
        .amount-words { background: #eff6ff; padding: 8px 12px; margin-bottom: 12px; border-left: 3px solid #2E86AB; border-radius: 0 4px 4px 0; font-size: 9.5px; }
        .amount-words strong { color: #1E3A5F; }
        .bank-details { padding: 10px 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; font-size: 8.5px; margin-top: 10px; }
        .bank-details h4 { color: #166534; margin-bottom: 4px; font-size: 9.5px; }
        .conditions { margin-top: 10px; padding: 8px 12px; background: #f8fafc; border-radius: 4px; font-size: 8px; color: #64748b; }
        .conditions h4 { color: #475569; margin-bottom: 3px; font-size: 9px; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; font-size: 7.5px; color: #9ca3af; border-top: 2px solid #1E3A5F; padding: 8px 15mm; background: white; }
    </style>
</head>
<body>
    <!-- Header with Logo -->
    <div class="header">
        <div class="header-left">
            {% if logo_base64 %}
            <img src="{{ logo_base64 }}" alt="Logo" class="logo-img" style="margin-bottom:8px;">
            {% endif %}
            <div class="company-name">{{ settings.companyName }}</div>
            <div class="company-info">
                {{ settings.address }}<br>
                {% if settings.postalCode %}BP : {{ settings.postalCode }} {% endif %}{{ settings.city }}, {{ settings.country }}<br>
                T√©l : {{ settings.phones }} | Email : {{ settings.email }}
                {% if settings.website %}<br>{{ settings.website }}{% endif %}
            </div>
            <div class="company-legal">
                {% if settings.rccm %}RCCM : {{ settings.rccm }}{% endif %}
                {% if settings.taxId %} | N¬∞ Contrib. : {{ settings.taxId }}{% endif %}
            </div>
        </div>
        <div class="header-right">
            <div class="doc-info-grid">
                <div class="doc-info-row"><span class="doc-info-label">Date d'√©mission</span><span class="doc-info-value">{{ invoice.issueDate|date('d/m/Y') }}</span></div>
                <div class="doc-info-row"><span class="doc-info-label">Date d'√©ch√©ance</span><span class="doc-info-value">{{ invoice.dueDate|date('d/m/Y') }}</span></div>
                {% if invoice.proforma %}<div class="doc-info-row"><span class="doc-info-label">R√©f. proforma</span><span class="doc-info-value">{{ invoice.proforma.reference }}</span></div>{% endif %}
            </div>
        </div>
    </div>

    <!-- Title -->
    <div class="title-bar">
        <div class="title-bar-left">
            <h1>FACTURE</h1>
        </div>
        <div class="title-bar-right">
            <div class="ref">N¬∞ {{ invoice.reference }}</div>
        </div>
    </div>

    <!-- Client Info -->
    <div class="info-section">
        <div class="info-box">
            <div class="info-label">Factur√© √†</div>
            <div class="client-name">{{ invoice.client.name }}</div>
            <div class="client-info">
                {% if invoice.client.address %}{{ invoice.client.address }}<br>{% endif %}
                {% if invoice.client.city %}{{ invoice.client.city }}{% if invoice.client.country %}, {{ invoice.client.country }}{% endif %}<br>{% endif %}
                {% if invoice.client.phone %}T√©l : {{ invoice.client.phone }}<br>{% endif %}
                {% if invoice.client.email %}{{ invoice.client.email }}{% endif %}
                {% if invoice.client.taxId %}<br>NUI : {{ invoice.client.taxId }}{% endif %}
            </div>
        </div>
        <div class="info-box right">
            <!-- Status badge -->
            {% if invoice.status == 'paid' %}
                <span class="status-badge status-paid">‚úì R√âGL√âE</span>
            {% elseif invoice.isOverdue is defined and invoice.isOverdue %}
                <span class="status-badge status-overdue">‚ö† EN RETARD</span>
            {% else %}
                <span class="status-badge status-pending">‚è≥ EN ATTENTE</span>
            {% endif %}
            {% if invoice.object %}<div style="font-size:10px;margin-top:5px;"><strong>Objet :</strong> {{ invoice.object }}</div>{% endif %}
        </div>
    </div>

    <div class="accent-bar"></div>

    <!-- Items Table -->
    <table class="items">
        <thead>
            <tr>
                <th style="width:5%">#</th>
                <th style="width:40%">D√©signation</th>
                <th style="width:10%" class="center">Qt√©</th>
                <th style="width:15%" class="right">P.U. ({{ settings.currency }})</th>
                <th style="width:10%" class="center">Remise</th>
                <th style="width:20%" class="right">Total ({{ settings.currency }})</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.items %}
            <tr>
                <td class="center">{{ loop.index }}</td>
                <td>
                    <div class="item-name">{{ item.designation }}</div>
                    {% if item.description %}<div class="item-desc">{{ item.description }}</div>{% endif %}
                </td>
                <td class="center">{{ item.quantityFloat|number_format(2, ',', ' ') }}</td>
                <td class="right">{{ item.unitPriceFloat|number_format(0, ',', ' ') }}</td>
                <td class="center">{{ item.discountFloat > 0 ? item.discountFloat ~ '%' : '-' }}</td>
                <td class="right"><strong>{{ item.totalFloat|number_format(0, ',', ' ') }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Totals and Notes -->
    <div class="totals-section">
        <div class="notes-box">
            {% if invoice.notes %}
            <div class="notes">
                <h4>Notes</h4>
                <p>{{ invoice.notes|nl2br }}</p>
            </div>
            {% endif %}
        </div>
        <div class="totals-box">
            <table class="totals">
                <tr><td>Total HT</td><td class="right">{{ invoice.totalHTFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                {% if invoice.taxRateFloat > 0 %}
                <tr><td>{{ settings.taxLabel|default('TVA') }} ({{ invoice.taxRateFloat }}%)</td><td class="right">{{ invoice.totalTVAFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                {% endif %}
                <tr class="total-row"><td>TOTAL TTC</td><td class="right">{{ invoice.totalTTCFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                {% if invoice.amountPaidFloat is defined and invoice.amountPaidFloat > 0 %}
                <tr class="paid-row"><td>D√©j√† pay√©</td><td class="right">- {{ invoice.amountPaidFloat|number_format(0, ',', ' ') }} {{ settings.currency }}</td></tr>
                <tr class="due-row"><td><strong>Reste √† payer</strong></td><td class="right"><strong>{{ invoice.remainingAmount|number_format(0, ',', ' ') }} {{ settings.currency }}</strong></td></tr>
                {% endif %}
            </table>
        </div>
    </div>

    <!-- Amount in words -->
    <div class="amount-words">
        <strong>Arr√™t√© la pr√©sente facture √† la somme de :</strong>
        {{ invoice.totalTTCFloat|number_format(0, ',', ' ') }} {{ settings.currency }}
    </div>

    <!-- Bank details -->
    {% if settings.bankDetails %}
    <div class="bank-details">
        <h4>üí≥ Coordonn√©es bancaires</h4>
        <p>{{ settings.bankDetails|nl2br }}</p>
    </div>
    {% endif %}

    <!-- Conditions -->
    {% if invoice.conditions %}
    <div class="conditions">
        <h4>Conditions de paiement</h4>
        <p>{{ invoice.conditions|nl2br }}</p>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="footer">
        {{ settings.companyName }} ‚Äî {{ settings.address }}, {{ settings.city }}
        {% if settings.rccm %} | RCCM : {{ settings.rccm }}{% endif %}
        | T√©l : {{ settings.phones }} | {{ settings.email }}
    </div>
</body>
</html>
